---
title: "Count data and the Poisson distribution"
author: "Frank Edwards"
output: binb::metropolis
---

```{r setup, echo = FALSE, message = FALSE}
rm(list=ls())
library(tidyverse)
library(broom)
select<-dplyr::select
set.seed(1)

options(xtable.comment = FALSE)
theme_set(theme_bw())
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})
knitr::opts_chunk$set(warning=FALSE, message=FALSE, tidy = TRUE, size = "small")
```

## Count data

- Counts are cumulative totals of the number of incidences of some event, generally across time or place \pause
- Counts are positive integers $\in [0,\infty]$  \pause

## Counts as extensions of binary data

- Counts can be thought of as repeated binary trials
- $\sum{y_i}$ where y is equal to 1 or 0 provides a count
- Generally, we could treat \texttt{sum(y==1) + sum(y==0)} or \texttt{nrow(y)} as the exposure, or denominator for a rate. Why?

## An example of count data
```{r message = FALSE, size = "tiny"}
load("./data/fieldplayer_overall_season_stats.rda")
load("./data/player.rda")

nwsl_stats<-fieldplayer_overall_season_stats
nwsl_players<-player

head(nwsl_players)
```

## make a joined table with players names

```{r}
### attaching names
dat<-nwsl_stats %>% 
  left_join(nwsl_players %>% 
              select(person_id, player))

### check to ensure that the dimensions are what we want
nrow(dat) == nrow(nwsl_stats)

### if we have multiple positions for players
dat<-nwsl_stats %>% 
  left_join(nwsl_players)
```



# Approaches to modeling count data

## The Poisson model

Where y is a non-negative integer (count)

$$y \sim Poisson (\lambda)$$
$$E(y) = \bar{y} = \lambda$$
$$Var(y)=\lambda $$
$$Pr(y = k) = \frac{\lambda^k e^{-\lambda}}{k!} $$

## Shape of the Poisson distribution
```{r, echo = FALSE}
p1<-rpois(10000, 1)
p2<-rpois(10000, 2)
p3<-rpois(10000, 3)
p4<-rpois(10000, 4)
p5<-rpois(10000, 5)
p6<-rpois(10000, 6)
p7<-rpois(10000, 7)
p8<-rpois(10000, 8)
p9<-rpois(10000, 9)


pois_demo<-data.frame(count = c(p1, p2, p3, p4, p5, p6, p7, p8, p9), 
                      lambda = rep(1:9, each = 10000))
```

```{r}
ggplot(pois_demo, aes(x=count)) + 
  geom_density(adjust = 1/4) + 
  facet_wrap(~lambda)
```

## Let's look at each Poisson variable

```{r size = "scriptsize"}
pois_demo%>%group_by(lambda)%>%
  
  summarise(mean = mean(count),
            variance = var(count))
```

## Poisson models as a GLM

For a count variable $y$, we can specify a Poisson GLM with a log link function

$$ y \sim Poisson(\lambda) $$
$$ \lambda = e^{\beta X} = e^{\beta_0 + \beta_1 x_1 \cdots \beta_n x_n} $$
$$E(y|x) = e^\lambda $$
$$log(E(y|x)) = \lambda = \beta X $$

## Model NWSL data as a Poisson GLM

```{r}
m0_mp<-glm(mp ~ 
             1,
           data = dat,
           family = "poisson")

### check to see if the data looks similar to the poisson
data_sim<-data.frame(
  y_pred = rpois(nrow(dat), 13.54815),
  mp = dat$mp
)

## evaluate the distributions
ggplot(data_sim,
       aes(x = y_pred)) + 
  geom_histogram(fill = "red", alpha = 0.5) + 
  geom_histogram(aes(x = mp), fill = "blue", alpha = 0.5)

```

## Modeling assists

```{r}
assist_0<-glm(ast ~ 1,
              data = dat,
              family = "poisson")

sim_dat<-data.frame(
  y_pred = rpois(nrow(dat), 0.9782119),
  ast = dat$ast
)

ggplot(sim_dat,
       aes(x = y_pred)) + 
  geom_histogram(fill = "red", alpha =0.5) + 
  geom_histogram(aes(x = ast), fill = "blue", alpha = 0.5)

assist_1<-lm(ast~1,
             data = dat)

sim_dat<-sim_dat %>% 
  mutate(y_pred_norm = rnorm(nrow(dat), 0.9782, 1.492429))

ggplot(sim_dat,
       aes(x = y_pred)) + 
  geom_histogram(fill = "red", alpha =0.5) + 
  geom_histogram(aes(x = ast), fill = "blue", alpha = 0.5) + 
  geom_histogram(aes(x = y_pred_norm), fill = "black", alpha =0.5)
```


```{r}
assist_2<-glm(ast~
                gls,
              data = dat,
              family = "poisson")

### let's compare model fits to see if we are doing better
BIC(assist_0)
BIC(assist_2, assist_0)
### model 2 is a big improvement

sim_dat<-sim_dat %>% 
  mutate(y_pred2 = rpois(nrow(dat),
                         predict(assist_2, type = "response")))


ggplot(sim_dat,
       aes(x = y_pred2)) + 
  geom_histogram(fill = "red", alpha = 0.5)+
  geom_histogram(aes(x = ast), fill = "blue", alpha = 0.5)

BIC(assist_2, assist_0)

```

```{r}
assist_3<-glm(ast~
                gls + mp,
              data = dat,
              family = "poisson")

BIC(assist_3, assist_2, assist_0)

sim_dat<-sim_dat %>% 
  mutate(y_pred3 = rpois(nrow(dat),
                         predict(assist_3, type = "response")))

ggplot(sim_dat,
       aes(x = y_pred3)) + 
  geom_histogram(fill = "red", alpha = 0.5)+
  geom_histogram(aes(x = ast), fill = "blue", alpha = 0.5)

```

## let's generate predictions for players

```{r}
### take our two predictors
### define reasonable ranges to predict over
mp<-1:24
gls<-0:5
### generate expected values
fake_data<- expand_grid(mp, gls) 

fake_data<-fake_data%>% 
  mutate(expected_assists = 
           predict(assist_3, fake_data,
                   type = "response"))

ggplot(fake_data,
       aes(x = mp, y = expected_assists,
           color = factor(gls))) + 
  geom_line()
```



## Advantages of the Poisson distribution for regression

1. Constrained to non-negative integers
2. Variance scales with the expectation of y 
3. Relatively simple to interpret

However: 

$$\lambda = E(y|x) = var(y)$$
  
## Homework

1. Visualize the distribution of goals across players for the 2019 season (your choice on geom)
2. Define a linear predictor for goals made during a season, where the players' position is the only predictor.
3. Estimate this model with a Normal likelihood (OLS)
4. Estimate this model with a Poisson likelihood (family = "poisson")
5. Generate predictions for each position for both models
6. Compare the predictions. Which model do you prefer? Why? 