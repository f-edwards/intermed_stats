---
title: "Untitled"
author: "Frank Edwards"
date: "3/8/2021"
output: html_document
---

## Homework 5

Let's break down the process: what are the steps within each step. 

Who was most (and least) likely to die on the Titanic? Use `~/hw/data/titanic.csv` for this one.

```{r setup, warning = FALSE, message = FALSE, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(tidyverse)
library(rstan)
library(rstanarm)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

titanic<-read_csv("./data/titanic.csv")
```

## 1. Write out a model 

We are modeling survival as the outcome.

- Theorize the model: what do we think affected risk of death

Passenger class: indicated social worth, and physical proximity to lifeboats
Fare: we can assume that passengers who paid more for their tickets had higher levels of wealth, fare is a proxy for wealth

The valuation of human life on a cruise ship in the early 20th c. was tied to social class, largely determined by wealth.

Sex: two reasons - women were given priority (a la the movie), men could have a higher rate of survival because sexism? maybe there are class differences in the survival rate by gender. very wealthy women maybe most likely to survive. lower class men maybe more likely as essential laborers

chivalric sexism: paternalism in ideologies of protection extend to upper class women, but not to lower class women

age: old ppl overlooked - old couple was like screw it, we're gonna die anyway
right hand side (elders) - lower survival
left hand side (children) - higher survival, probably gradient by class in terms of social valuation in probability of getting to lifeboats (might think of a child effect, and a physical ability effect)

- Write it out mathematically

Because survival is a binary outcome, we will model the probability of survival with a logistic regression model, where survival has the following probability distribution:

$$survival_i \sim Binomial(1, p_i) $$

the simple additive model: 

$$ logit(p_i) = \beta_0 + \beta_1 \times class_i +  \beta_2 \times sex_i + \beta_3 \times age_i $$
## why no error term in logistic models

the normal can be written like this:

$$y_i = \beta_0 + \beta_1x_1 + \varepsilon$$
$$\varepsilon \sim N(0, \sigma) $$

I can also write the model with NO error term

$$\mu_i = \beta_0 + \beta_1x_1$$
$$ y_i \sim N(\mu_i, \sigma) $$

2. Fit the model

Fit the simple additive model first

```{r model1}
m1<-glm(Survived ~ factor(Pclass) + Sex + Age,
        data = titanic,
        family = "binomial")
```

Interpret it using fake data

```{r prediction}
Pclass<-c(1,2,3)
Sex<-c("male", "female")
Age<-0:80
### expand_grid makes a data frame with every possible combination of the 
## supplied vectors
fake_data<-expand_grid(Pclass,
                       Sex,
                       Age)
### to get it on the probability, not log odds scale, use type response
#p_hat<-predict(m1, newdata=fake_data, type = "response")
### attach this to fake_data
fake_data<-fake_data %>% 
  mutate(p_hat = 
           predict(m1, newdata=fake_data, type = "response"))


## now to visualize
ggplot(fake_data,
       aes(x = Age, y = p_hat, color = factor(Pclass))) + 
  geom_line() + 
  facet_wrap(~Sex)
```

The plot shows that all three variables are related to survival probability. Likelihood of death increases with age, increases as passenger class decreases, and is higher for females. First class girls were the most likely to survive. Third class elderly men were the least likely to survive.

3. Think about revising the model

We suggested earlier that class and sex may interact with each other. For example, first class women are likely perceived to be more 'virtuous' than 3rd class women, thus more likely to get access to lifeboats. 

Let's rewrite our linear predictor to include a test for this possible interaction

$$ logit(p_i) = \beta_0 + \beta_1 \times class_i +  \beta_2 \times sex_i + \beta_3 \times age_i + \beta_4 \times class_i \times sex_i$$

```{r}
m2<-glm(Survived ~ factor(Pclass) + Sex + Age +
          Sex * factor(Pclass),
        data = titanic,
        family = "binomial")
### predict for our new model
fake_data<-fake_data %>% 
  mutate(p_hat2 = predict(m2, newdata = fake_data, type = "response"))

### visualize
ggplot(fake_data,
       aes(x = Age, y = p_hat2, color = factor(Pclass))) + 
  geom_line() + 
  #geom_line(aes(y = p_hat), lty=2) + 
  facet_wrap(~Sex)
```

Maybe age also has complex effects. Children are most likely to survive. The elderly are least likely.

```{r}
m3<-glm(Survived ~ factor(Pclass) + Sex + Age +
          Sex * factor(Pclass) + 
          (Age<=12) + (Age>=60),
        data = titanic,
        family = "binomial")

### predict for our new model
fake_data<-fake_data %>% 
  mutate(p_hat3 = predict(m3, newdata = fake_data, type = "response"))

### visualize
ggplot(fake_data,
       aes(x = Age, y = p_hat3, color = factor(Pclass))) + 
  geom_line() + 
  #geom_line(aes(y = p_hat), lty=2) + 
  facet_wrap(~Sex)
```

Let's get wild with making complicated models

```{r}
m4<-glm(Survived ~ factor(Pclass) + Sex + Age +
          Sex * factor(Pclass) + 
          (Age<=12)* factor(Pclass) + (Age>=60)* factor(Pclass),
        data = titanic,
        family = "binomial")

### predict for our new model
fake_data<-fake_data %>% 
  mutate(p_hat4 = predict(m4, newdata = fake_data, type = "response"))

### visualize
ggplot(fake_data,
       aes(x = Age, y = p_hat4, color = factor(Pclass))) + 
  geom_line() + 
  #geom_line(aes(y = p_hat), lty=2) + 
  facet_wrap(~Sex)
```

4. Compare model fits

Use BIC to compare the fits of each model. 

```{r}
BIC(m1)
BIC(m2)
BIC(m3)
BIC(m4)

BIC(m1, m2, m3, m4)

### test a fully interacted model
m5<-glm(Survived ~ factor(Pclass) * Age * Sex,
        data = titanic,
        family = "binomial")

BIC(m1, m2, m3, m4, m5)
```

Using the Bayesian Information Criterion, we determine that model 2 provides the most efficient fit of the data.

```{r}
plot_data<-fake_data %>% 
  pivot_longer(cols = p_hat:p_hat4,
               values_to = "p_hat",
               names_to = "model_number")

ggplot(plot_data,
       aes(x = Age, y = p_hat,
           color = factor(Pclass))) + 
  geom_line() + 
  facet_wrap(model_number~Sex,
             ncol = 4)
```


5. Interpret the model 

BIC told us model 2 was the best, so let's interpret that.

```{r}
ggplot(plot_data %>% 
         filter(model_number == "p_hat2"),
       aes(x = Age, y = p_hat,
           color = factor(Pclass))) + 
  geom_line() + 
  facet_wrap(~Sex)
```

The figure shows a clear age / sex / class pattern to survival. First and second class girls were most likely to survive. 2nd and 3rd class elderly men were least likely to survive. First class men were less likely to survive than 2nd class women. For example, a 2 year old first class girl has a `r round(fake_data %>% filter(Pclass == 1, Sex == "female", Age==2) %>% select(p_hat2),2)` probability of survival. A third class 65 year old man has a `r round(fake_data %>% filter(Pclass == 3, Sex == "male", Age==65) %>% select(p_hat2),2)` probability of survival. 


